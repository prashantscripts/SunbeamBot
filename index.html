<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Voice-Enabled Chatbot</title>
</head>
<body>
  <div>
    <h1>Voice-Enabled Chatbot</h1>
    <textarea id="chatBox" rows="10" cols="50" readonly></textarea>
    <br />
    <button id="speakBtn">Speak</button>
    <p id="errorMsg" style="color: red;"></p>
  </div>

  <script>
    const API_URL = 'https://api-bf738831-5030-460b-9891-ac5446aae79c.sendbird.com/v3';
    const API_TOKEN = '06ab48d570b66099a56975c0de1ad7762ea904b6';
    const USER_ID = 'sbsg';

    // Text-to-Speech
    const speakText = (text) => {
      const msg = new SpeechSynthesisUtterance(text);
      msg.lang = 'en-US';
      window.speechSynthesis.speak(msg);
    };

    // Check for Speech Recognition compatibility
    let recognition;
    try {
      const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;
      recognition = new SpeechRecognition();
      recognition.lang = 'en-US';
      recognition.interimResults = false;
    } catch (e) {
      document.getElementById('errorMsg').innerText = 'Speech Recognition API is not supported in this browser.';
    }

    const chatBox = document.getElementById('chatBox');
    const speakBtn = document.getElementById('speakBtn');

    // Start Speech Recognition when Speak button is clicked
    if (recognition) {
      speakBtn.addEventListener('click', () => {
        recognition.start();
        document.getElementById('errorMsg').innerText = 'Listening... Speak now!';
      });

      recognition.onresult = async (event) => {
        const userInput = event.results[0][0].transcript;
        chatBox.value += `You: ${userInput}\n`;
        document.getElementById('errorMsg').innerText = ''; // Clear error message

        // Send user input to Sendbird
        try {
          const response = await fetch(`${API_URL}/users/${USER_ID}/messages`, {
            method: 'POST',
            headers: {
              'Content-Type': 'application/json; charset=utf8',
              'Api-Token': API_TOKEN
            },
            body: JSON.stringify({
              message_type: 'MESG',
              user_id: USER_ID,
              message: userInput
            })
          });

          const data = await response.json();
          if (data.error) {
            chatBox.value += `Error: ${data.message}\n`;
          } else {
            const botResponse = data.message;
            chatBox.value += `Bot: ${botResponse}\n`;
            speakText(botResponse);
          }
        } catch (err) {
          chatBox.value += `Error sending message: ${err.message}\n`;
        }
      };

      recognition.onerror = (error) => {
        document.getElementById('errorMsg').innerText = `Speech recognition error: ${error.error}`;
      };
    }
  </script>
</body>
</html>